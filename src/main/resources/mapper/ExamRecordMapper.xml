<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.exam.mapper.ExamRecordMapper">
    
    <!-- 考试排行榜查询 - 使用关联查询优化性能 -->
    <select id="selectExamRanking" resultType="com.exam.vo.ExamRankingVO">
        SELECT 
            er.id,                                              <!-- 考试记录ID -->
            er.student_name as studentName,                     <!-- 考生姓名 -->
            er.score,                                           <!-- 考试得分 -->
            er.exam_id as examId,                               <!-- 试卷ID -->
            p.name as paperName,                                <!-- 试卷名称（关联查询获取） -->
            p.total_score as paperTotalScore,                   <!-- 试卷总分（关联查询获取） -->
            er.start_time as startTime,                         <!-- 开始时间 -->
            er.end_time as endTime,                             <!-- 结束时间 -->
            <!-- 计算考试用时（分钟） -->
            CASE 
                WHEN er.end_time IS NOT NULL AND er.start_time IS NOT NULL 
                THEN TIMESTAMPDIFF(MINUTE, er.start_time, er.end_time)
                ELSE NULL 
            END as duration
        FROM exam_records er
        <!-- LEFT JOIN关联paper表获取试卷名称和总分 -->
        LEFT JOIN paper p ON er.exam_id = p.id
        WHERE er.status = '已批阅'                              <!-- 只查询已批阅的考试记录 -->
        <!-- 动态添加试卷ID条件 -->
        <if test="paperId != null">
            AND er.exam_id = #{paperId}
        </if>
        <!-- 按分数降序排列，分数相同按用时升序排列 -->
        ORDER BY er.score DESC, duration ASC
        <!-- 动态添加数量限制 -->
        <if test="limit != null and limit > 0">
            LIMIT #{limit}
        </if>
    </select>
    
</mapper> 